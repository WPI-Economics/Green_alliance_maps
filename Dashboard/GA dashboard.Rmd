---
title: "GA Dashboard"
author: "WPI Economics"
output:
  flexdashboard::flex_dashboard:
    theme: paper
---

```{r setup, include=FALSE}
#Green Alliance dashboard

library(tidyverse)
library(shiny)
library(crosstalk)
library(flexdashboard)
library(sf)
library(leaflet)
library(leaflet.extras)
library(reactable)
library(downloadthis)
library(htmltools)

#Read in data
df.sf <- readRDS("GA_DB.RDS")
#download data
df <- st_drop_geometry(df.sf)
df.sf <- st_transform(df.sf, 4326)

df.sp <- df.sf %>% as('Spatial')





sd <- SharedData$new(df.sf,
                     key = df.sf$pcon19cd)

sd.map <- SharedData$new(df.sp,
                     key = df.sp@data$pcon19cd, group = sd$groupName()
                     
)

```

Interactives {data-icon="ion-stats-bars"}
=====================================  

Column {data-width=550}
-------------------------------------

### Filters

```{r filters}
# filter_select(
#   id = "geo_pcon",
#   label = "Constituency",
#   sharedData = sd,
#   group = ~`Constituency`
# )

bscols(
  filter_checkbox(
    id = "seagrass",
    label = "Seagrass within 1000m",
    sharedData = sd,
    group = ~`Seagrass location within 1000m`
  ),
  
  filter_checkbox(
    id = "woodland",
    label = "Share of woodland (cum %)",
    sharedData = sd,
    group = ~`Share of woodland (cumulative %)`
  ),
    filter_checkbox(
    id = "map",
    label = "Coastal map test",
    sharedData = sd,
    group = ~`Coastal resoration priority sites flag`
  )
)
# bscols(
#   filter_slider(
#     id = "pupil_count",
#     label = "Pupil count",
#     sharedData = sd,
#     column = ~pupil_count,
#     step = 10,
#     round = TRUE,
#     sep = "",
#     ticks = FALSE
#   ),
#   filter_slider(
#     id = "pupil_percent_fsm",
#     label = "Percentage Free School Meals",
#     sharedData = sd,
#     column = ~pupil_percent_fsm,
#     step = 1,
#     round = TRUE,
#     sep = "",
#     ticks = FALSE
#   )
# )
```

### Datatable
    
```{r datatable}
tbl <- reactable(sd, #selection = "multiple",
                 onClick = "select",
                 rowStyle = list(cursor = "pointer"),
                 minRows = 10,filterable = F,searchable = F, wrap = T , defaultPageSize = 15, striped = T, highlight = T,
                 defaultSorted = list("Constituency" = "asc"),
                 columns = list(`Seagrass location within 1000m` = colDef(filterable = F),
                                `Coastal resoration sites flag` = colDef(filterable = F),
                                `Share of woodland (cumulative %)` = colDef(filterable = F),
                                `Within 10k of great north bog` = colDef(filterable = F),
                                `Coastal resoration priority sites flag` = colDef(filterable = F),
                                geometry = colDef(show = F), 
                                pcon19cd = colDef(show = F),
                                cols = colDef(show = F)
                                ),
                 #`COVID-19 deaths per 100,000` = colDef(aggregate = "mean",format = colFormat(digits = 0)),
                 #`COVID-19 deaths age adjusted per 100,000` = colDef(aggregate = "mean",format = colFormat(digits = 0))),
                 theme = reactableTheme(
                   stripedColor = "#f3f5f4",
                   highlightColor = "#8B9C98",
                   cellPadding = "6px 10px",
                   style = list(fontFamily = "Franklin Gothic Book", fontSize = "12px"),
                   #searchInputStyle = list(width = "100%", fontWeight = "400"),
                   headerStyle = list(color = "white",background = "#00946E",
                                      "&:hover[aria-sort]" = list(background = "#76B74B"),
                                      "&[aria-sort='ascending'], &[aria-sort='descending']" = list(background = "#76B74B"),
                                      borderColor = "#76B74B"
                   )
                 )) 

dl.button <- df %>%
  download_this(
    output_name = "NAME_THIS_FILE",
    output_extension = ".csv",
    button_label = "Download data as csv",
    button_type = "default",
    has_icon = TRUE,
    icon = "fa fa-save"
  )

combo <- htmltools::tagList(dl.button, tbl) 
combo
```

Column {data-width=400}
-------------------------------------
    
### Interactive map
    
```{r map}

cols <- c("#f0cfc7",
          "#dca091",
          "#c4725f",
          "#a94330",
          "#8a0000")

meanval <- mean(df.sf$`Labour market challenge score (100 = average)`)
sdval <- sd(df.sf$`Labour market challenge score (100 = average)`)

#written long
very.high <- paste0("Greater than ",round(meanval + (sdval*1.5),0))
high <- paste0("Greater than ",round(meanval + (sdval*0.5),0) , " and less than ",round(meanval + (sdval*1.5),0)   )
average <- paste0("Greater than ",round(meanval - (sdval*0.5),0) , " and less than ",round(meanval + (sdval*0.5),0)  )
low <- paste0("Greater than ", round(meanval - (sdval*1.5),0), " and less than ", round(meanval - (sdval*0.5),0)  )
very.low <- paste0("Less than ", round(meanval - (sdval*1.5) ,0))

long.cats <- c(very.high, high, average, very.low, low)

#condensed
very.high.sht <- paste0("> ",round(meanval + (sdval*1.5),0))
high.sht <- paste0("> ",round(meanval + (sdval*0.5),0) , " <= ",round(meanval + (sdval*1.5),0)   )
average.sht <- paste0("> ",round(meanval - (sdval*0.5),0) , " <= ",round(meanval + (sdval*0.5),0)  )
low.sht <- paste0("> ", round(meanval - (sdval*1.5),0), " <= ", round(meanval - (sdval*0.5),0)  )
very.low.sht <- paste0("<= ", round(meanval - (sdval*1.5) ,0))

short.cats <- c(very.high.sht, high.sht, average.sht, very.low.sht, low.sht)

labels1 <- sprintf("<strong>%s</strong><br/>Challenge score: %s<sup></sup><br/>",
                   df.sf$Constituency, df.sf$`Labour market challenge score (100 = average)`) %>%
  lapply(htmltools::HTML)


plot <- leaflet(sd.map, options= leafletOptions(padding = 100, zoomSnap = 0.25, zoomDelta = 0.3, zoomControl = T)) %>%
  setView(lng =  -3.13,
          lat = 54.8,zoom = 6.3) %>% #setView gives centre coordinates and zoom level

  setMapWidgetStyle(list(background = "white")) %>%
  #addProviderTiles(providers$CartoDB.PositronNoLabels, providerTileOptions(opacity = 1) ) %>%

  addPolygons(stroke = T, color = "white",
              #layerId = ~pcon19cd,
              fillColor = ~cols,
              opacity = 1,
              fillOpacity = 1, weight = 0.25, label = labels1,
              highlight= highlightOptions(color="white", weight=2, bringToFront= T))  %>%



  addLegend(colors = rev(cols),
            labels = c(
              paste0("Very high (", very.high.sht,")"),
              paste0("High (",high.sht,")"),
              paste0("Average (",average.sht,")"),
              paste0("Low (", low.sht,")"),
              paste0("Very low (",very.low.sht,")")
              ),
            position = "topright",
            title="Labour market challenge score",
            opacity=1) %>%

  removeDrawToolbar(clearFeatures = T)


plot

  
  
```

Information {data-orientation=rows data-icon="fa-info-circle"}
===================================== 


### Blurb

This example was shown as part of the talk <i>Crosstalk: Shiny-like without Shiny</i> at the [Enterprise Applications of the R Language (EARL) conference in London, September 2018](https://earlconf.com/2018/london/#matt-dray).

> Self-service interactive tools have great power to support decisions by policy-makers. Shiny apps are a natural fit for this, but it's not always easy to share them within the public sector. This is due to issues like a lack of server space, highly sensitive data and users who aren't R-savvy.
>
>We've approached this problem in the UK's Department for Education by sharing interactive HTML widgets – embeddable JavaScript visualisation libraries – within RMarkdown outputs. Interactivity is, however, limited because selections in one widget don’t impact the data presented in another.
>
>[Joe Cheng's Crosstalk package](http://rstudio.github.io/crosstalk/) overcomes this with shared data objects that react to user inputs, altering the content of multiple widgets on the fly. I'll explain how I used Crosstalk to develop a 'pseudo-app' for exploring schools data with the Leaflet (maps), Plotly (charts) and DT (tables) widgets inside the Flexdashboard framework and how I shared it easily with policy-making users as a static HTML file for exploration in the browser.
Note that this material is restricted to **published data only** and **does not reflect or constitute official government policy**.

### How to use

#### Filters

You can:

* select one or more local authorities from the dropdown menu (remove them with your backspace key)
* select one or more Ofsted grades using the checkboxes
* select the phase of education with the checkboxes
* drag the slider to select a pupil count
* drag the slider to filter by the percenatge of pupils receiving free school meals

#### Interactive map

You can:

* click to grab and drag the map around
* zoom with the '+' and '--' buttons (top-left) or with your mouse's scroll wheel
* click a marker to reveal a popup with information about that school
* click the button showing a broken square (top-left under the zoom options) to select points on the map using a window that's draggable (click and hold the grid icon in the upper left) and resizeable (click and drag the white boxes in each corner)

#### Interactive table

You can:

* filter each column by typing in the boxes under each column header
* sort the columns (ascending and descending) by clicking on the column header
* change which columns are visible by clicking the Column visibility button
* click 'CSV' or 'Excel' to download the filtered data to a .csv file or a .xlsx
* see how many entries remain after filtering in the bottom-left, where it says 'Showing X to Y of Z entries'

### Tools

[R v3.4.4](https://www.r-project.org/) and [RStudio v1.1.442](https://www.rstudio.com/) were used to build this tool.

The packages used were:

* [Flexdashboard](https://rmarkdown.rstudio.com/flexdashboard/) to create a frame for the content
* [Leaflet](https://rstudio.github.io/leaflet/) for the interactive map
* [DT](https://rstudio.github.io/DT/) for the interactive table
* [Crosstalk](https://rstudio.github.io/crosstalk/) for widget interactivity
* [Ion icons](https://ionicons.com/) and [Font Awesome](https://fontawesome.com/) for icons

The code for this tool is available from [github.com/matt-dray/earl18-crosstalk](https://github.com/matt-dray/earl18-crosstalk). The presentation is available from [github.com/matt-dray/earl18-presentation](https://github.com/matt-dray/earl18-presentation).